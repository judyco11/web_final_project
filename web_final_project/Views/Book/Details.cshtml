@model OnlineBookStore.Models.Book

@{
    ViewData["Title"] = Model?.Title ?? "Book Details";
}
<hr class="my-4" />

@if (User.Identity?.IsAuthenticated ?? false)
{
    <h4>Leave a Review</h4>

    <form asp-controller="Review" asp-action="Add" method="post" class="mt-3">
        <input type="hidden" name="bookId" value="@Model.Id" />

        <div class="mb-3">
            <label class="form-label">Rating</label>
            <select name="rating" class="form-select" required>
                <option value="">Select rating</option>
                <option value="5">★★★★★</option>
                <option value="4">★★★★☆</option>
                <option value="3">★★★☆☆</option>
                <option value="2">★★☆☆☆</option>
                <option value="1">★☆☆☆☆</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Comment</label>
            <textarea name="comment" class="form-control" rows="3"></textarea>
        </div>

        <button class="btn btn-primary">Submit Review</button>
    </form>
}
else
{
    <div class="alert alert-info mt-3">
        Please <a asp-controller="Account" asp-action="Login">log in</a> to leave a review.
    </div>
}
@if (Model == null)
{
    <div class="alert alert-danger mt-4">Book not found.</div>
    return;
}

<div class="row mt-4">
    <div class="col-md-4">
        <img src="@Model.CoverImageUrl"
             class="img-fluid rounded border"
             alt="Book Cover"
             onerror="this.src='/images/no-image.png';" />
    </div>

    <div class="col-md-8">
        <h2>@Model.Title</h2>
        <h5 class="text-muted">@Model.Author</h5>

        <p class="mt-3">
            <strong>Category:</strong>
            @(Model.Category?.Name ?? "Uncategorized")
        </p>

        @if (!string.IsNullOrWhiteSpace(Model.Edition))
        {
            <p><strong>Edition:</strong> @Model.Edition</p>
        }

        <p><strong>Price:</strong> @Model.Price.ToString("C")</p>

        <p>
            <strong>Stock:</strong>
            @Model.Stock
        </p>

        @if (User.Identity?.IsAuthenticated ?? false)
        {
            <form asp-controller="Cart" asp-action="Add" method="post" class="mt-3">
                <input type="hidden" name="bookId" value="@Model.Id" />

                <div class="input-group" style="max-width: 220px;">
                    <input type="number" name="quantity" value="1" min="1" max="@Model.Stock" class="form-control" @(Model.Stock == 0 ? "disabled" : "") />
                    <button class="btn btn-success" @(Model.Stock == 0 ? "disabled" : "")>Add to Cart</button>
                </div>
                @if (Model.Stock == 0)
                {
                    <p class="text-danger mt-2">Out of stock</p>
                }

            </form>
        }
        else
        {
            <div class="alert alert-warning mt-3">
                Please <a asp-controller="Account" asp-action="Login">log in</a> to add this book to your cart.
            </div>
        }
    </div>
</div>

<hr class="my-4" />

<h4>Reviews</h4>

@if (Model.Reviews == null || !Model.Reviews.Any())
{
    <p class="text-muted">No reviews yet.</p>
}
else
{
    foreach (var r in Model.Reviews.OrderByDescending(r => r.CreatedAt))
    {
        <div class="border rounded p-3 mb-3">
            <strong>@(r.AppUser?.Email ?? "Unknown User")</strong>

            <span class="text-warning ms-2">
                @for (int i = 0; i < r.Rating; i++)
                {
                    @:★
                }
            </span>

            @if (!string.IsNullOrWhiteSpace(r.Comment))
            {
                <p class="mt-2">@r.Comment</p>
            }

            <small class="text-muted">@r.CreatedAt.ToShortDateString()</small>
        </div>
    }
}